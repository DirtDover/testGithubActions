# IDOR (Insecure Direct Object Reference)

## What you will learn in this course üßêüßê

- Understand the concept of Insecure Direct Object Reference (IDOR)
- Learn how to exploit IDOR vulnerabilities

A **direct object reference** occurs when an application uses user input directly to access internal objects such as files, database records, or configuration settings, without additional validation or access control. This mechanism can be legitimately necessary in specific situations to improve efficiency and simplify operations.

In a legitimate context, the use of direct object references might be required for the following reasons:

1. **Fast Resource Access**: In applications where performance is crucial, directly accessing objects via a unique reference can reduce the complexity of queries and improve response speed. For example, a content management system (CMS) might allow administrators to access a file or document directly by specifying its path or unique identifier in the URL, simplifying navigation and maintenance tasks.

2. **User-Specific Service Customization**: A website offering personalized user areas might use direct references to display documents, files, or specific settings for a user. For example, a billing portal could allow a user to view their invoices by directly accessing a URL containing a unique invoice identifier, which refers directly to a record in the database.

3. **Simplifying Shared Links**: When there‚Äôs a need to share direct links to specific resources, a direct object reference can be used. For instance, an online storage service could generate a unique link that allows the download of a specific file without needing to go through a complex user interface.

4. **Managing RESTful APIs**: In a RESTful architecture, objects are often referenced directly by identifiers in the URLs to interact with resources. For example, an API managing users could allow access to a specific user‚Äôs details via a structured URL like `/api/users/123`, where `123` is the unique identifier of the user.

While using direct object references can be justified for reasons of simplicity and efficiency, it presents security risks. To avoid issues like **Insecure Direct Object Reference (IDOR)**, it is crucial to implement strict access controls and ensure that every request is authorized and validated before allowing access to sensitive objects. This can include the use of access tokens, verifying user permissions, and input validation to prevent malicious manipulation of references.

## Exploiting IDOR Vulnerabilities

**Insecure Direct Object Reference (IDOR)** vulnerabilities arise when an application directly references internal objects, such as files, database records, or URLs, using user-supplied input without properly validating the user's permissions. These flaws enable attackers to manipulate input parameters to access unauthorized data or perform actions beyond their intended permissions.

To illustrate, consider a scenario where a user is granted access to their profile page by a URL parameter such as `user_id`. If the application doesn't verify whether the logged-in user has the rights to view the data associated with that `user_id`, an attacker can modify this parameter to gain access to other users' profiles.

![[IDOR.png]]

### Basic IDOR Techniques

#### URL Manipulation

In many web applications, URLs are used to directly reference specific resources or user data. If these URLs include parameters that represent object IDs (e.g., user IDs, document IDs) and the application fails to validate whether the user is authorized to access those objects, it opens up the application to IDOR attacks.

- **Vulnerable Code Example**:

```php
<?php
// Assume the user is viewing their profile page
$user_id = $_GET['user_id'];
$query = "SELECT * FROM users WHERE user_id = $user_id";
$result = mysqli_query($conn, $query);
?>
```

- **Exploitation**:

If the URL is structured like `http://example.com/profile.php?user_id=123`, an attacker could simply change the `user_id` parameter to `124` to access another user's profile:

```bash
http://example.com/profile.php?user_id=124
```

#### Parameter Tampering

Parameter tampering involves modifying parameters within a request to access data or functions that the user should not have access to. This could be done in POST requests, GET requests, or even hidden form fields.

- **Vulnerable Code Example**:

```php
<?php
// Assume a POST request updates the user's email
$user_id = $_POST['user_id'];
$email = $_POST['email'];
$query = "UPDATE users SET email='$email' WHERE user_id=$user_id";
mysqli_query($conn, $query);
?>
```

- **Exploitation**:

An attacker could modify the `user_id` parameter in the POST request to update another user's email address:

```bash
POST /update_email.php HTTP/1.1
Host: example.com

user_id=124&email=hacker@example.com
```

### Advanced IDOR Techniques

#### Enumeration

Enumeration involves systematically guessing or brute-forcing object identifiers to gain unauthorized access to multiple resources. If object IDs are predictable, such as sequential numbers, an attacker can exploit this by iterating through them.

- **Vulnerable Code Example**:

```php
<?php
$doc_id = $_GET['doc_id'];
$query = "SELECT * FROM documents WHERE doc_id = $doc_id";
$result = mysqli_query($conn, $query);
?>
```

- **Exploitation**:

An attacker could exploit this by iterating over document IDs:

```bash
http://example.com/document.php?doc_id=1
http://example.com/document.php?doc_id=2
http://example.com/document.php?doc_id=3
```

This would allow access to various documents, potentially exposing sensitive information.

#### Session Fixation

Session fixation attacks exploit weaknesses in how sessions are managed. If session IDs are not properly regenerated after login or are predictable, an attacker can fix a session ID and later hijack the user's session.

- **Vulnerable Code Example**:

```php
<?php
session_start();
if (isset($_SESSION['user_id'])) {
	$query = "SELECT * FROM orders WHERE user_id=" . $_SESSION['user_id'];
	$result = mysqli_query($conn, $query);
}
?>
```

- **Exploitation**:

If the application doesn‚Äôt regenerate session IDs after a user logs in, an attacker could use a known or predictable session ID to hijack a session:

```bash
http://example.com/orders.php?PHPSESSID=knownsessionid
```

### Exploiting API Endpoints

#### API Testing

APIs are often vulnerable to IDOR if object references within requests are not properly validated. This is particularly dangerous in RESTful APIs where object identifiers are frequently passed in requests.

- **Vulnerable Code Example**:

```json
POST /api/v1/orders
{
  "order_id": 123,
  "user_id": 456
}
```

- **Exploitation**:

By modifying the `user_id` in an API request, an attacker could gain access to another user's order details:

```bash
POST /api/v1/orders
{
  "order_id": 123,
  "user_id": 457
}
```

#### GraphQL Manipulation

GraphQL APIs allow clients to specify the structure of the response data. If object references within these queries are not validated, an attacker can manipulate them to retrieve unauthorized data.

- **Vulnerable Query Example**:

```graphql
query {
  user(id: "123") {
    email
    orders {
      id
      amount
    }
  }
}
```

- **Exploitation**:

An attacker could change the `id` parameter to access another user‚Äôs data:

```graphql
query {
  user(id: "124") {
    email
    orders {
      id
      amount
    }
  }
}
```

### Bypassing Access Controls

#### Role Manipulation

Role-based access control (RBAC) systems determine what users are allowed to do based on their assigned roles. If role identifiers can be manipulated in requests, attackers can escalate their privileges.

- **Vulnerable Code Example**:

```php
<?php
$role_id = $_POST['role_id'];
$query = "UPDATE users SET role_id=$role_id WHERE user_id=" . $_SESSION['user_id'];
mysqli_query($conn, $query);
?>
```

- **Exploitation**:

An attacker could escalate their privileges by changing the `role_id` in the POST request, potentially granting themselves admin rights:

```bash
POST /update_role.php HTTP/1.1
Host: example.com

role_id=1  # Assuming '1' is the admin role
```

#### Privilege Escalation

Privilege escalation via IDOR occurs when attackers manipulate object references to access administrative functions or higher-level data.

- **Vulnerable Code Example**:

```php
<?php
// Admin panel access
if ($_GET['admin'] == 'true') {
	$query = "SELECT * FROM users";
	$result = mysqli_query($conn, $query);
}
?>
```

- **Exploitation**:

An attacker could gain access to the admin panel by manipulating the `admin` parameter in the URL:

```bash
http://example.com/admin_panel.php?admin=true
```

### Exploiting File References

#### File ID Manipulation

File ID manipulation occurs when file references in URLs or requests can be altered to access files belonging to other users. This can lead to the exposure of private documents, images, or other files stored on the server.

- **Vulnerable Code Example**:

```php
<?php
$file_id = $_GET['file_id'];
$query = "SELECT file_path FROM files WHERE file_id = $file_id";
$result = mysqli_query($conn, $query);
?>
```

- **Exploitation**:

An attacker could manipulate the `file_id` parameter to access files that belong to other users:

```bash
http://example.com/download.php?file_id=124
```

This would allow the attacker to download or view files they should not have access to.

## Mitigation Techniques

To effectively counteract Insecure Direct Object Reference (IDOR) vulnerabilities, it's crucial to apply robust access control measures and avoid directly exposing internal references. Instead of relying solely on client-side validation, ensure that all access to sensitive resources is regulated by server-side checks based on user permissions.

Implement indirect object references or tokens that are securely managed and validated on the server side. For instance, rather than exposing a user's profile ID in a URL, use a secure token that maps to the user ID. This approach mitigates the risk of unauthorized access resulting from manipulation of object IDs. Additionally, it's essential to validate and sanitize all user inputs to ensure they conform to expected formats and prevent potential injection attacks.

In terms of session management, always regenerate session IDs after user authentication to guard against session fixation attacks. Ensure session IDs are complex and random, making them difficult to predict. For API security, validate object references and user permissions before processing any requests to prevent unauthorized data access.

Implement comprehensive logging and monitoring to detect and respond to unusual access patterns or potential attacks. Regularly review logs for any signs of suspicious activity, and employ real-time monitoring systems to provide immediate alerts about anomalous behavior.

Here's an example of how to securely handle object references in PHP, ensuring robust protection against IDOR vulnerabilities:

```php
<?php
// Start the session and check if the user is authenticated
session_start();
if (!isset($_SESSION['user_id'])) {
    header('Location: login.php');
    exit;
}

// Database connection
$host = 'localhost';
$user = 'root';
$password = '';
$dbname = 'example_db';
$conn = new mysqli($host, $user, $password, $dbname);
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Retrieve the secure token from the request
$token = $_GET['token'] ?? '';

// Prepare and execute a query to find the user ID associated with the token
$query = "SELECT user_id FROM user_tokens WHERE token = ?";
$stmt = $conn->prepare($query);
$stmt->bind_param('s', $token);
$stmt->execute();
$stmt->store_result();

// Check if the token is valid
if ($stmt->num_rows === 1) {
    // Fetch the user ID from the token
    $stmt->bind_result($user_id_from_token);
    $stmt->fetch();

    // Ensure the logged-in user matches the user ID from the token
    if ($user_id_from_token === $_SESSION['user_id']) {
        // Prepare a query to retrieve user profile data
        $query = "SELECT * FROM users WHERE user_id = ?";
        $stmt = $conn->prepare($query);
        $stmt->bind_param('i', $_SESSION['user_id']);
        $stmt->execute();
        $result = $stmt->get_result();

        // Display user profile data
        if ($row = $result->fetch_assoc()) {
            echo "Name: " . htmlspecialchars($row['name']) . "<br />";
            echo "Email: " . htmlspecialchars($row['email']) . "<br />";
        } else {
            echo "User not found.";
        }

        // Close the statement
        $stmt->close();
    } else {
        echo "Access denied.";
    }
} else {
    echo "Invalid token.";
}

// Close the database connection
$conn->close();
?>
```

In this example, the code begins by starting a session and confirming that the user is logged in. It then establishes a connection to the database. Instead of using direct object references, it retrieves a secure token from the URL and validates it against the database. If the token is valid and corresponds to the logged-in user, the application retrieves and displays user profile data. By using prepared statements, the code prevents SQL injection attacks. Additionally, it ensures output is sanitized with `htmlspecialchars()` to guard against XSS vulnerabilities. This secure approach ensures that only authorized users can access their data and that object references are handled safely.

## Detection Techniques

Detecting IDOR vulnerabilities involves a combination of automated and manual methods. Regular penetration testing is essential, as it simulates real-world attacks to identify potential weaknesses in your access control mechanisms. This type of testing can reveal vulnerabilities that may not be apparent through automated scanning alone.

Automated scanning tools can also play a significant role in detecting IDOR vulnerabilities. These tools are designed to identify common issues, such as exposed object references or predictable identifiers in URLs and API endpoints. However, automated tools should be complemented with manual reviews to ensure comprehensive coverage.

Monitoring access logs is another critical technique for detecting IDOR vulnerabilities. By analyzing logs, you can identify suspicious activities such as repeated attempts to access various resources or unusual patterns of access that deviate from normal behavior.

Incorporating real-time monitoring systems that alert you to anomalous behavior can provide timely insights into potential threats, allowing you to respond quickly to mitigate risks. Regular code reviews focusing on how object references are managed can also help uncover potential vulnerabilities early in the development process.

## Resources

- [PortSwigger IDOR](https://portswigger.net/web-security/access-control/idor)
- [What are IDORs](https://www.invicti.com/learn/insecure-direct-object-references-idor/)
