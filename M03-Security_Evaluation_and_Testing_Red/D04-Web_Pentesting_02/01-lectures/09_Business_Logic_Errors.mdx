# Business Logic Errors

## What you will learn in this course üßêüßê

- Understand the concept of Business Logic Errors
- Learn how to exploit Business Logic Errors vulnerabilities

Business logic in web applications refers to the core set of rules and processes that determine how the application handles, processes, and manages data according to the specific needs of a business or organization. It is the part of the software that embodies the business's operational rules and procedures, ensuring that the application behaves in a way that aligns with the company's goals and workflows.

In practical terms, business logic dictates how data is treated as it flows through the application. For example, in an e-commerce website, the business logic governs how products are priced, how discounts are applied, how inventory levels are maintained, and how orders are processed. It decides what actions should be taken based on certain conditions, such as whether a customer is eligible for a discount or whether an order can be fulfilled based on available stock.

Unlike presentation logic, which focuses on how data is displayed to users, business logic is concerned with the meaning and appropriate use of that data within the context of the business. It interacts closely with databases, enforcing rules like data validation, performing calculations, and guiding decision-making processes. For instance, it ensures that a user cannot place an order for a product that is out of stock or that a payment cannot be processed if required information is missing.

The complexity of business logic can vary widely depending on the application's purpose. It can range from straightforward rules, such as verifying that a username is unique, to more intricate workflows that manage entire processes, like the lifecycle of a product from order placement to delivery.

### Exploitation

Attackers exploit Business Logic Errors by manipulating application workflows or transaction sequences to bypass intended restrictions or achieve unauthorized access. This can result from flawed validation logic, improper access controls, or incomplete threat modeling during application development. Here is how it can happen :

1. The attacker manipulates application workflows or transaction sequences to bypass intended restrictions.
2. This allows unauthorized access or unintended operations within the application.
3. The attacker exploits flaws in business logic to gain financial benefits or access sensitive data.

![Business_Logic_Errors](https://cyber-lead-assets.s3.amazonaws.com/M01-Security_Evaluation_and_Testing_(Red)/D05-Web_Pentesting_02/01-lectures/Business_Logic.png)

## Techniques for Finding and Exploiting Business Logic Vulnerabilities

Business logic vulnerabilities in web applications are subtle flaws that occur due to incorrect assumptions or gaps in how the application's processes or rules are implemented. Below is a breakdown of techniques to identify and exploit these vulnerabilities, organized by type and accompanied by examples.

### Parameter and Data Manipulation

#### Parameter Manipulation

Attackers manipulate parameters within web requests to alter the behavior of an application. This could involve changing values, adding or removing parameters, or altering the data type to bypass restrictions.

**Example:** Imagine an e-commerce site where the price of a product is passed in a hidden form field:

```html
<form action="/checkout" method="POST">
  <input type="hidden" name="product_id" value="123">
  <input type="hidden" name="price" value="100">
  <input type="submit" value="Buy">
</form>
```

An attacker might intercept the request and modify the `price` parameter to a lower value before submitting it:

```http
POST /checkout HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded

product_id=123&price=1
```

If the application does not validate the price on the server side, the attacker could purchase the item for a fraction of its true cost.

#### Data Flow Manipulation

Injecting unexpected data into the processing flow can cause the application to behave unpredictably or crash.

**Example:** A web application might accept an `amount` parameter that is expected to be a positive integer:

```php
$amount = $_GET['amount'];
if ($amount > 0) {
    // Process the amount
    echo "Amount processed: " . $amount;
}
```

An attacker could try to inject a negative or extremely large value:

```http
GET /process?amount=-1000 HTTP/1.1
Host: example.com
```

If the application doesn't properly handle such values, it might lead to unexpected behavior or security breaches.

### Access and Process Flow Exploitation

#### Access Control Bypass

Attackers may attempt to bypass access controls by manipulating session tokens, altering URL paths, or finding unprotected resources.

**Example:** Consider a URL where only admin users should access the `/admin` page:

```php
if ($_SESSION['role'] == 'admin') {
    header('Location: /admin');
} else {
    header('Location: /login');
}
```

If the session token or role can be manipulated (for instance, through a cookie), an attacker could gain unauthorized access to the admin panel:

```http
GET /admin HTTP/1.1
Host: example.com
Cookie: PHPSESSID=abcd1234; role=admin
```

#### Process Flow Manipulation

In multi-step processes, attackers might skip steps, reorder them, or repeat them inappropriately to achieve unintended results.

**Example:** In a multi-step checkout process, each step is validated sequentially:

```php
if ($step == 1) {
    // Validate address
} elseif ($step == 2) {
    // Validate payment
} elseif ($step == 3) {
    // Confirm order
}
```

If the application allows direct access to step 3 without completing the previous steps, an attacker could skip the payment step:

```http
GET /checkout?step=3 HTTP/1.1
Host: example.com
```

This could result in an order being confirmed without payment.

### Abuse of Functionality and Constraints

#### Exploiting Limits and Constraints

Attackers might exceed the limits of what‚Äôs allowed, such as submitting more data than permitted or abusing time-based restrictions.

**Example:** A site might allow users to withdraw funds, but with a daily limit:

```php
$withdrawn_today = $_SESSION['withdrawn_today'];
$amount = $_POST['amount'];
if ($withdrawn_today + $amount <= 1000) {
    // Allow withdrawal
    $_SESSION['withdrawn_today'] += $amount;
}
```

An attacker could attempt to withdraw in small increments, or manipulate the `amount` parameter to bypass the limit:

```http
POST /withdraw HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded

amount=999
```

They repeat the process multiple times until the daily limit is bypassed.

#### Abusing Features

Attackers may take advantage of poorly enforced features, such as exploiting free trials by creating multiple accounts.

**Example:** A web service offering a 30-day free trial might not enforce a check on the email domain, allowing attackers to register multiple accounts using disposable email addresses:

```html
<form action="/register" method="POST">
  <input type="email" name="email" placeholder="Enter your email">
  <input type="submit" value="Sign Up">
</form>
```

If the application does not verify the uniqueness of email domains or IP addresses, attackers could repeatedly exploit the free trial by registering with multiple emails like `user1@mailinator.com`, `user2@mailinator.com`, etc.

### Client-Side and Concurrent Request Exploitation

#### Client-Side Validation Bypass

When validation is only performed on the client side, attackers can bypass it by interacting directly with the server.

**Example:** Consider an application where a form field is validated using JavaScript:

```html
<script>
  function validate() {
      var quantity = document.getElementById("quantity").value;
      if (quantity < 1 || quantity > 10) {
          alert("Quantity must be between 1 and 10");
          return false;
      }
      return true;
  }
</script>
```

An attacker could disable JavaScript or intercept the request to submit a value outside the expected range:

```http
POST /order HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded

quantity=100
```

If the server does not revalidate the input, this could result in unintended behavior.

#### Exploiting Race Conditions

Attackers exploit race conditions by sending multiple concurrent requests to manipulate temporary states.

**Example:** In a scenario where an application updates inventory when a purchase is made, an attacker might send multiple requests simultaneously to purchase the same item, potentially causing the inventory to go negative:

```http
POST /purchase HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded

item_id=123&quantity=1
```

By automating this request and sending it multiple times concurrently, the attacker might succeed in buying more items than are available.

## Mitigation Techniques

Mitigating business logic vulnerabilities requires a proactive approach that involves both thorough design practices and ongoing security measures. Start by conducting comprehensive threat modeling during the application design phase. This process helps identify potential weaknesses in the business logic by mapping out critical workflows and decision points. Ensure that the development team has a deep understanding of the business processes being implemented, as well as the potential risks associated with each decision point.

Next, implement strict input validation and access control mechanisms. Input validation should be done server-side to ensure that all data, especially critical parameters, conforms to the expected format and values. Access control mechanisms must be robust, ensuring that users can only perform actions that align with their roles and permissions. Regularly update and patch the application to address known vulnerabilities, and apply the principle of least privilege to minimize the potential impact of any breach.

It's also essential to conduct regular security testing, including automated vulnerability scans and manual penetration testing. These tests should be designed to simulate real-world attacks, focusing specifically on business logic flaws. Additionally, incorporate secure coding practices throughout the development lifecycle, including peer code reviews and static code analysis, to catch logic errors before they reach production.

## Detection Techniques

Detecting business logic vulnerabilities can be challenging due to their subtle nature, but a combination of monitoring, testing, and advanced analytics can help. Continuous security testing, such as automated regression testing, can catch unexpected behavior that might indicate a logic flaw. These tests should simulate various user interactions and edge cases to uncover vulnerabilities that may not be evident during normal operation.

Application logs are another critical tool for detection. By monitoring logs for unusual patterns or deviations from typical user behavior, you can identify potential exploit attempts. For example, repeated access to restricted areas or attempts to bypass certain steps in a process might indicate an ongoing attack. Implementing anomaly detection systems that use machine learning to analyze user behavior can further enhance your ability to detect suspicious activities that may signal an exploitation of business logic vulnerabilities.

Finally, consider employing behavioral analysis tools that track user interactions over time, establishing a baseline of normal activity. These tools can flag deviations from this baseline, such as a sudden increase in certain types of transactions or unexpected changes in how users interact with the application. By combining these detection methods, you can improve your chances of identifying and responding to business logic attacks before they cause significant damage.

## Resources

- [3 Creative Way to Exploit Business Logic](https://pentest-tools.com/blog/business-logic-vulnerabilities-pentests)
- [PortSwigger Example of Business Logic Vulnerabilities](https://portswigger.net/web-security/logic-flaws/examples)
